<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoMap Interaktif - Cilacap</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: sans-serif; }
        #video-section { height: 40%; background: #000; position: relative; }
        #map { height: 60%; width: 100%; cursor: crosshair; }
        #player { width: 100%; height: 100%; }
        .instructions { 
            position: absolute; top: 10px; left: 10px; 
            background: rgba(255,255,255,0.9); padding: 8px; 
            border-radius: 4px; font-size: 11px; z-index: 1000; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<div id="video-section">
    <div id="player"></div>
    <div class="instructions">
        <strong>Tips:</strong> Klik pada jalur biru di peta untuk melompat ke menit video tersebut.
    </div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const youtubeId = 'FImt8Q6sOXo';
    const gpxFilePath = 'ruasjalan15.gpx'; // Sesuaikan nama file .gpx Anda

    let map, marker, player, trackLine;
    let routeData = []; 

    // 1. Inisialisasi Map
    map = L.map('map').setView([-7.71, 109.01], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // 2. Load GPX & Bangun Logika Interaktif
    fetch(gpxFilePath)
        .then(res => res.text())
        .then(xmlText => {
            const parser = new DOMParser();
            const xml = parser.parseFromString(xmlText, "text/xml");
            const points = xml.getElementsByTagName("trkpt");
            let firstTime = null;

            for (let i = 0; i < points.length; i++) {
                const lat = parseFloat(points[i].getAttribute("lat"));
                const lon = parseFloat(points[i].getAttribute("lon"));
                const time = new Date(points[i].getElementsByTagName("time")[0].textContent);
                
                if (i === 0) firstTime = time;
                const seconds = (time - firstTime) / 1000;

                routeData.push({ time: seconds, latlng: [lat, lon] });
            }

            // Gambar Jalur
            trackLine = L.polyline(routeData.map(d => d.latlng), {
                color: '#3388ff',
                weight: 6,
                opacity: 0.6
            }).addTo(map);

            // EVENT KLIK PADA JALUR
            trackLine.on('click', function(e) {
                findClosestPoint(e.latlng);
            });

            marker = L.circleMarker(routeData[0].latlng, {
                color: 'red', radius: 8, fillOpacity: 1
            }).addTo(map);

            map.fitBounds(trackLine.getBounds());
        });

    // 3. Fungsi Mencari Titik Terdekat saat Peta Diklik
    function findClosestPoint(clickedLatLng) {
        let minDistance = Infinity;
        let targetTime = 0;

        routeData.forEach(point => {
            const dist = L.latLng(point.latlng).distanceTo(clickedLatLng);
            if (dist < minDistance) {
                minDistance = dist;
                targetTime = point.time;
            }
        });

        // Lompat ke waktu video (seek)
        if (player && player.seekTo) {
            player.seekTo(targetTime, true);
            player.playVideo();
        }
    }

    // 4. YouTube API & Sync (Video -> Map)
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            videoId: youtubeId,
            events: { 'onStateChange': onPlayerStateChange }
        });
    }

    function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
            updateMarker();
        }
    }

    function updateMarker() {
        if (player && player.getPlayerState() === YT.PlayerState.PLAYING) {
            const now = player.getCurrentTime();
            const closest = routeData.reduce((prev, curr) => 
                (Math.abs(curr.time - now) < Math.abs(prev.time - now) ? curr : prev)
            );

            if (closest) {
                marker.setLatLng(closest.latlng);
                // Opsional: aktifkan jika ingin map bergerak otomatis mengikuti video
                // map.panTo(closest.latlng); 
            }
            requestAnimationFrame(updateMarker);
        }
    }
</script>
</body>
</html>
