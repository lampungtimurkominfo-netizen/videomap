<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoMap - Lampung Timur</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        #video-container { height: 45%; background: #000; position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 10; }
        #map { height: 55%; width: 100%; }
        #player { width: 100%; height: 100%; }
        
        .overlay-info {
            position: absolute; top: 10px; left: 10px;
            background: rgba(0, 0, 0, 0.7); color: white;
            padding: 8px 15px; border-radius: 20px;
            font-size: 12px; pointer-events: none; z-index: 1000;
        }
    </style>
</head>
<body>

<div id="video-container">
    <div id="player"></div>
    <div class="overlay-info" id="status">Memuat data sensor...</div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Konfigurasi Utama
    const youtubeId = 'FImt8Q6sOXo';
    const gpxRawUrl = 'https://raw.githubusercontent.com/lampungtimurkominfo-netizen/videomap/refs/heads/main/ruasjalan15.gpx';

    let map, marker, player, trackLine;
    let routeData = []; 

    // 1. Inisialisasi Peta
    map = L.map('map', { zoomControl: false }).setView([-5.1, 105.7], 12); 
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // 2. Load GPX dari Link Raw
    fetch(gpxRawUrl)
        .then(response => {
            if (!response.ok) throw new Error("Gagal akses file raw GitHub");
            return response.text();
        })
        .then(gpxData => {
            const parser = new DOMParser();
            const xml = parser.parseFromString(gpxData, "text/xml");
            const points = xml.getElementsByTagName("trkpt");
            
            let firstTime = null;

            for (let i = 0; i < points.length; i++) {
                const lat = parseFloat(points[i].getAttribute("lat"));
                const lon = parseFloat(points[i].getAttribute("lon"));
                
                // Parsing waktu (jika ada)
                let seconds = 0;
                const timeTag = points[i].getElementsByTagName("time")[0];
                if (timeTag) {
                    const currentTime = new Date(timeTag.textContent);
                    if (!firstTime) firstTime = currentTime;
                    seconds = (currentTime - firstTime) / 1000;
                } else {
                    // Fallback jika tidak ada tag waktu: asumsi 1 point = 1 detik
                    seconds = i; 
                }

                routeData.push({ time: seconds, latlng: [lat, lon] });
            }

            // Gambar Garis Jalan
            trackLine = L.polyline(routeData.map(d => d.latlng), {
                color: '#2ecc71',
                weight: 5,
                opacity: 0.8
            }).addTo(map);

            // Sesuaikan tampilan peta ke jalur
            map.fitBounds(trackLine.getBounds());

            // Tambahkan Marker Posisi
            marker = L.circleMarker(routeData[0].latlng, {
                color: '#e74c3c', radius: 9, fillOpacity: 1, weight: 3, fillColor: '#fff'
            }).addTo(map);

            // INTERAKTIF: Klik peta -> Video melompat
            trackLine.on('click', function(e) {
                syncVideoToMap(e.latlng);
            });

            document.getElementById('status').innerText = "Data Sinkron - Klik jalur untuk navigasi";
        })
        .catch(err => {
            document.getElementById('status').innerText = "Error: " + err.message;
        });

    // 3. Fungsi YouTube API
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            videoId: youtubeId,
            playerVars: { 'autoplay': 0, 'rel': 0 },
            events: { 'onStateChange': onPlayerStateChange }
        });
    }

    function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
            updateMarkerPosition();
        }
    }

    // 4. SINKRONISASI: Video ke Peta
    function updateMarkerPosition() {
        if (player && player.getPlayerState() === YT.PlayerState.PLAYING) {
            const currentTime = player.getCurrentTime();
            
            // Cari titik koordinat terdekat berdasarkan waktu video
            const closest = routeData.reduce((prev, curr) => 
                (Math.abs(curr.time - currentTime) < Math.abs(prev.time - currentTime) ? curr : prev)
            );

            if (closest) {
                marker.setLatLng(closest.latlng);
                
                // Auto-pan: Geser peta perlahan agar marker tetap di tengah
                if (!map.getBounds().contains(closest.latlng)) {
                    map.panTo(closest.latlng);
                }
            }
            requestAnimationFrame(updateMarkerPosition);
        }
    }

    // 5. SINKRONISASI: Peta ke Video
    function syncVideoToMap(clickedLatLng) {
        let minDistance = Infinity;
        let targetTime = 0;

        routeData.forEach(point => {
            const dist = L.latLng(point.latlng).distanceTo(clickedLatLng);
            if (dist < minDistance) {
                minDistance = dist;
                targetTime = point.time;
            }
        });

        if (player) {
            player.seekTo(targetTime, true);
            player.playVideo();
        }
    }
</script>
</body>
</html>
