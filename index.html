<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoMap Smooth Sync</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            height: 100vh;
            font-family: sans-serif;
        }

        /* === CONTAINER UTAMA === */
        .container {
            display: flex;
            flex-direction: row;
            height: 100vh;
            width: 100%;
        }

        /* === VIDEO === */
        #video-section {
            flex: 1;
            background: #000;
            position: relative;
            min-width: 300px;
        }

        #player {
            width: 100%;
            height: 100%;
        }

        /* === MAP === */
        #map {
            flex: 1;
            min-width: 300px;
        }

        /* === STATUS OVERLAY === */
        .status-overlay {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 11px;
            z-index: 1000;
        }

        /* === RESPONSIVE MOBILE === */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            #video-section {
                height: 40%;
            }

            #map {
                height: 60%;
            }
        }
    </style>
</head>
<body>


<div class="container">
    <div id="video-section">
        <video id="player" controls>
        </video>

        <div class="status-overlay">
            SYNC ACTIVE
        </div>
    </div>
    <div id="map"></div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const youtubeId = 'FImt8Q6sOXo';
    const gpxRawUrl = 'https://raw.githubusercontent.com/lampungtimurkominfo-netizen/videomap/refs/heads/main/ruasjalan15.gpx';
    // === DATA JEMBATAN (TANPA UBAH GPX) ===
    
    const bridgePoint = {
        id: "KB-18-0007-0015-J001",
        name: "R.015-J01",
        road: "Adirejo - Batas Kota Metro (Karang Rejo)",
        lat: -5.0900361,
        lng: 105.3394861,
        zoom: 18
    };

    
    

    let map, marker, player, trackLine, bridgeMarker;
    let routeData = []; 
    let isDataLoaded = false;

    // 1. Inisialisasi Peta
    map = L.map('map').setView([-5.094, 105.340], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // === MARKER JEMBATAN ===
    bridgeMarker = L.marker(
        [bridgePoint.lat, bridgePoint.lng],
        {
            icon: L.divIcon({
            className: "bridge-icon",
            html: "üèó",
            iconSize: [30, 30],
            iconAnchor: [15, 30]
            })
        }
    ).addTo(map);

    bridgeMarker.bindPopup(`
    <div style="font-size:13px; line-height:1.4">
        <b>üèó ${bridgePoint.name}</b><br>
        <small>${bridgePoint.road}</small><br><br>

        <button onclick="focusBridge()"
            style="
                width:100%;
                margin-bottom:6px;
                padding:6px 10px;
                background:#2ecc71;
                color:white;
                border:none;
                border-radius:4px;
                cursor:pointer;">
            üìç Fokus ke Jembatan
        </button>

        <a href="https://www.google.com/maps?q=${bridgePoint.lat},${bridgePoint.lng}"
           target="_blank"
           style="
                display:block;
                text-align:center;
                padding:6px 10px;
                background:#3498db;
                color:white;
                text-decoration:none;
                border-radius:4px;">
            üó∫ Buka di Google Maps
        </a>
    </div>
    `);

    // 2. Load & Parse GPX
    fetch(gpxRawUrl)
        .then(res => res.text())
        .then(xmlText => {
            const parser = new DOMParser();
            const xml = parser.parseFromString(xmlText, "text/xml");
            const points = xml.getElementsByTagName("wpt"); 
            
            if (points.length === 0) throw new Error("File GPX tidak terbaca atau kosong");

            let firstTime = null;
            let tempRoute = [];

            for (let i = 0; i < points.length; i++) {
                const lat = parseFloat(points[i].getAttribute("lat"));
                const lon = parseFloat(points[i].getAttribute("lon"));
                const timeStr = points[i].getElementsByTagName("time")[0]?.textContent;
                
                if (!isNaN(lat) && !isNaN(lon)) {
                    let seconds = 0;
                    if (timeStr) {
                        const currentTime = new Date(timeStr).getTime();
                        if (firstTime === null) firstTime = currentTime;
                        seconds = (currentTime - firstTime) / 1000;
                    } else {
                        seconds = i * 3; // Fallback jika tidak ada waktu
                    }
                    tempRoute.push({ time: seconds, lat: lat, lng: lon });
                }
            }

            routeData = tempRoute;

            // Gambar Jalur
            trackLine = L.polyline(routeData.map(d => [d.lat, d.lng]), {
                color: '#2ecc71', weight: 6, opacity: 0.8
            }).addTo(map);

            map.fitBounds(trackLine.getBounds());

            // Marker awal
            marker = L.circleMarker([routeData[0].lat, routeData[0].lng], {
                color: '#e74c3c', radius: 8, fillOpacity: 1, fillColor: 'white', weight: 3
            }).addTo(map);

            isDataLoaded = true;
            document.getElementById('status').innerText = "Selesai: " + routeData.length + " titik sinkron.";
            
            // Klik peta untuk seek video
            trackLine.on('click', (e) => {
                const closest = findClosestPoint(e.latlng);
                if (player) player.seekTo(closest.time, true);
            });
        })
        .catch(err => {
            document.getElementById('status').innerText = "Error: " + err.message;
            console.error(err);
        });

    // 3. YouTube API
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            videoId: youtubeId,
            playerVars: { 'rel': 0, 'showinfo': 0 },
            events: { 'onStateChange': onPlayerStateChange }
        });
    }

    function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
            requestAnimationFrame(smoothUpdate);
        }
    }

    // 4. Interpolasi Smooth
    function smoothUpdate() {
        if (!isDataLoaded || !player || player.getPlayerState() !== 1) return;

        const now = player.getCurrentTime();
        let currentPos = null;

        // === DETEKSI MENDEKATI JEMBATAN ===
        /*
        const bridgeLatLng = L.latLng(bridgePoint.lat, bridgePoint.lng);
        const markerLatLng = L.latLng(currentPos[0], currentPos[1]);

        if (markerLatLng.distanceTo(bridgeLatLng) < 15) {
            if (!bridgeMarker.isPopupOpen()) {
            bridgeMarker.openPopup();
            }
        }
        */

        // Cari posisi di antara dua titik (Interpolasi)
        for (let i = 0; i < routeData.length - 1; i++) {
            const p1 = routeData[i];
            const p2 = routeData[i + 1];

            if (now >= p1.time && now <= p2.time) {
                const ratio = (now - p1.time) / (p2.time - p1.time);
                const lat = p1.lat + (p2.lat - p1.lat) * ratio;
                const lng = p1.lng + (p2.lng - p1.lng) * ratio;
                currentPos = [lat, lng];
                break;
            }
        }

        // Jika waktu video melebihi data GPX, ambil titik terakhir
        if (!currentPos && now > 0) {
            const last = routeData[routeData.length - 1];
            currentPos = [last.lat, last.lng];
        }

        if (currentPos) {
            marker.setLatLng(currentPos);
            // Opsional: aktifkan baris bawah jika ingin peta selalu mengikuti marker
            map.panTo(currentPos); 
        }

        /* === AUTO POPUP SAAT MENDEKATI JEMBATAN === */
        const d = L.latLng(currentPos).distanceTo([bridgePoint.lat, bridgePoint.lng]);
        if (d < 15 && !bridgeMarker.isPopupOpen()) {
            bridgeMarker.openPopup();
        }
        
        requestAnimationFrame(smoothUpdate);
    }

    function findClosestPoint(latlng) {
        return routeData.reduce((prev, curr) => 
            L.latLng(curr.lat, curr.lng).distanceTo(latlng) < L.latLng(prev.lat, prev.lng).distanceTo(latlng) ? curr : prev
        );
    }

    function focusBridge() {
        map.setView(
        [bridgePoint.lat, bridgePoint.lng],
        bridgePoint.zoom,
        { animate: true }
        );
    }
</script>
</body>
</html>
