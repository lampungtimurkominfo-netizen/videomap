<script>
    const youtubeId = 'FImt8Q6sOXo';
    const gpxRawUrl = 'https://raw.githubusercontent.com/lampungtimurkominfo-netizen/videomap/refs/heads/main/ruasjalan15.gpx';

    let map, marker, player, trackLine;
    let routeData = []; 

    map = L.map('map').setView([-5.094, 105.340], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    fetch(gpxRawUrl)
        .then(res => res.text())
        .then(xmlText => {
            const parser = new DOMParser();
            const xml = parser.parseFromString(xmlText, "text/xml");
            const points = xml.getElementsByTagName("wpt"); 
            
            let firstTime = null;
            for (let i = 0; i < points.length; i++) {
                const lat = parseFloat(points[i].getAttribute("lat"));
                const lon = parseFloat(points[i].getAttribute("lon"));
                const timeStr = points[i].getElementsByTagName("time")[0]?.textContent;
                
                if (lat && lon) {
                    const currentTime = new Date(timeStr);
                    if (!firstTime) firstTime = currentTime;
                    const seconds = (currentTime - firstTime) / 1000;
                    routeData.push({ time: seconds, lat: lat, lng: lon });
                }
            }

            trackLine = L.polyline(routeData.map(d => [d.lat, d.lng]), {
                color: '#2ecc71', weight: 5, opacity: 0.7
            }).addTo(map);

            map.fitBounds(trackLine.getBounds());

            marker = L.circleMarker(routeData[0] ? [routeData[0].lat, routeData[0].lng] : [0,0], {
                color: '#e74c3c', radius: 7, fillOpacity: 1, fillColor: 'white', weight: 3
            }).addTo(map);

            trackLine.on('click', (e) => {
                const closest = findClosestPointToClick(e.latlng);
                if (player) player.seekTo(closest.time, true);
            });
        });

    // --- FUNGSI INTERPOLASI AGAR SMOOTH ---
    function interpolate(now) {
        // Cari dua titik di mana waktu sekarang berada di antaranya
        for (let i = 0; i < routeData.length - 1; i++) {
            const p1 = routeData[i];
            const p2 = routeData[i + 1];

            if (now >= p1.time && now <= p2.time) {
                // Hitung rasio kemajuan antara dua titik tersebut (0.0 sampai 1.0)
                const ratio = (now - p1.time) / (p2.time - p1.time);
                
                // Hitung posisi lat/lng baru di antara p1 dan p2
                const lat = p1.lat + (p2.lat - p1.lat) * ratio;
                const lng = p1.lng + (p2.lng - p1.lng) * ratio;
                
                return [lat, lng];
            }
        }
        // Jika sudah di luar batas waktu GPX, kembalikan titik terakhir/pertama
        if (now < routeData[0].time) return [routeData[0].lat, routeData[0].lng];
        return [routeData[routeData.length-1].lat, routeData[routeData.length-1].lng];
    }

    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            videoId: youtubeId,
            events: { 'onStateChange': (e) => { if(e.data == 1) animate(); } }
        });
    }

    function animate() {
        if (player && player.getPlayerState() === 1) {
            const now = player.getCurrentTime();
            const smoothedLatLng = interpolate(now);
            
            if (smoothedLatLng) {
                marker.setLatLng(smoothedLatLng);
                // Ikuti marker secara otomatis
                map.panTo(smoothedLatLng, { animate: true, duration: 0.1 });
            }
            requestAnimationFrame(animate);
        }
    }

    function findClosestPointToClick(latlng) {
        return routeData.reduce((prev, curr) => 
            L.latLng(curr.lat, curr.lng).distanceTo(latlng) < L.latLng(prev.lat, prev.lng).distanceTo(latlng) ? curr : prev
        );
    }
</script>
